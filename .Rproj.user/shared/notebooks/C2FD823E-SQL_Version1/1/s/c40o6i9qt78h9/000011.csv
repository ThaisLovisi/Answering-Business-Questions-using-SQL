"0","query_pred <- ""WITH invoice_first_track AS"
"0","    ("
"0","     SELECT"
"0","         il.invoice_id invoice_id,"
"0","         MIN(il.track_id) first_track_id"
"0","     FROM invoice_line il"
"0","     GROUP BY 1"
"0","    )"
"0","SELECT"
"0","    album_purchase,"
"0","    COUNT(invoice_id) number_of_invoices,"
"0","    CAST(count(invoice_id) AS FLOAT) / ("
"0","                                         SELECT COUNT(*) FROM invoice"
"0","                                      ) percent"
"0","FROM"
"0","    ("
"0","    SELECT"
"0","        ifs.*,"
"0","        CASE"
"0","            WHEN"
"0","                 ("
"0","                  SELECT t.track_id FROM track t"
"0","                  WHERE t.album_id = ("
"0","                                      SELECT t2.album_id FROM track t2"
"0","                                      WHERE t2.track_id = ifs.first_track_id"
"0","                                     ) "
"0","                  EXCEPT "
"0","                  SELECT il2.track_id FROM invoice_line il2"
"0","                  WHERE il2.invoice_id = ifs.invoice_id"
"0","                 ) IS NULL"
"0","             AND"
"0","                 ("
"0","                  SELECT il2.track_id FROM invoice_line il2"
"0","                  WHERE il2.invoice_id = ifs.invoice_id"
"0","                  EXCEPT "
"0","                  SELECT t.track_id FROM track t"
"0","                  WHERE t.album_id = ("
"0","                                      SELECT t2.album_id FROM track t2"
"0","                                      WHERE t2.track_id = ifs.first_track_id"
"0","                                     ) "
"0","                 ) IS NULL"
"0","             THEN 'yes'"
"0","             ELSE 'no'"
"0","         END AS 'album_purchase'"
"0","     FROM invoice_first_track ifs"
"0","    )"
"0","GROUP BY album_purchase"""
"0",""
"0","run_query(query_pred)"
